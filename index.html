<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NorthStar Logistics | Professional VTC</title>

    <style>
        /* RESET & BASE */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #0d1117;
            color: white;
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* HEADER */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 10px 40px;
            background-color: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 999;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .logo-area { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        header img { width: 45px; height: 45px; border-radius: 4px; object-fit: contain; }
        header h1 { font-size: 1.2rem; letter-spacing: 1px; text-transform: uppercase; color: #4a6a8c; font-weight: 800; }

        nav { display: flex; align-items: center; }
        nav a {
            color: #cfd8e3;
            margin-left: 20px;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.85rem;
            transition: color 0.3s;
            white-space: nowrap;
        }

        nav a:hover { color: #4a6a8c; }
        .portal-btn { background: #4a6a8c; padding: 8px 18px; border-radius: 20px; color: white !important; }

        /* VIEW TOGGLE */
        .page-view { display: none; min-height: 100vh; padding-top: 70px; }
        .page-view.active { display: block; }

        /* HERO SECTIONS */
        .hero {
            height: 60vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            padding: 0 20px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out;
        }

        .hero::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(13, 17, 23, 0.4), rgba(13, 17, 23, 1));
            z-index: 1;
        }

        .hero > * { position: relative; z-index: 2; }
        .hero-title { font-size: 3.5rem; font-weight: 800; margin-bottom: 10px; }
        .hero-sub { font-size: 1.1rem; color: #8b9eb3; max-width: 700px; }

        /* RESPONSIVE GRID HELPERS */
        .responsive-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 20px;
        }

        /* RECRUITMENT MODAL */
        .recruit-modal {
            position: fixed; inset: 0; 
            background: rgba(0, 0, 0, 0.85);
            display: none; justify-content: center; align-items: center; z-index: 2000;
            backdrop-filter: blur(8px);
            padding: 20px;
        }
        
        .recruit-content {
            background: linear-gradient(135deg, rgba(16, 20, 26, 0.95), rgba(13, 17, 23, 0.98));
            padding: 30px;
            border-radius: 4px;
            width: 100%;
            max-width: 550px;
            text-align: center;
            border: 1px solid rgba(74, 166, 140, 0.3);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.8), 0 0 10px rgba(74, 166, 140, 0.2);
            position: relative;
            overflow: hidden;
            /* clip-path removed on mobile via media query for safety, kept here for desktop */
            clip-path: polygon(0 0, 100% 0, 100% 90%, 95% 100%, 0 100%);
        }

        /* Scanning Animation */
        .recruit-content::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(90deg, transparent, #4a6a8c, #00f2ff, #4a6a8c, transparent);
            animation: scan-line 3s linear infinite;
            z-index: 10;
            opacity: 0.8;
            box-shadow: 0 0 15px #00f2ff;
            pointer-events: none;
        }

        @keyframes scan-line {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .recruit-image {
            width: 100%;
            border-radius: 2px;
            margin-bottom: 20px;
            border: 1px solid rgba(74, 166, 140, 0.3);
            filter: brightness(0.9) contrast(1.1);
        }

        .recruit-content h3 {
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid rgba(74, 166, 140, 0.3);
            margin-bottom: 20px;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recruit-content h3::after {
            content: 'TERMINAL_ACTIVE';
            font-size: 0.6rem;
            background: rgba(74, 166, 140, 0.1);
            color: #4a6a8c;
            padding: 2px 6px;
            border: 1px solid rgba(74, 166, 140, 0.3);
        }

        .join-btn-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .join-option {
            background: rgba(13, 17, 23, 0.5);
            padding: 15px;
            border-radius: 2px;
            text-decoration: none;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: 0.3s;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            position: relative;
        }

        .join-option:hover { 
            background: rgba(74, 166, 140, 0.1); 
            border-color: #00f2ff; 
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
            transform: translateY(-2px);
        }

        .join-option.disabled {
            opacity: 1;
            background: rgba(243, 156, 18, 0.05);
            border: 1px solid rgba(243, 156, 18, 0.4);
            cursor: not-allowed;
            animation: amber-pulse 2s infinite alternate;
        }
        
        .join-option.disabled strong { color: #f39c12; text-shadow: 0 0 5px rgba(243, 156, 18, 0.4); }
        .join-option.disabled span { color: rgba(255,255,255,0.6); font-size: 0.8rem; }

        .join-option.disabled::after {
            content: 'DEV_LOCK';
            position: absolute;
            top: 5px; right: 5px;
            font-size: 0.5rem;
            color: #f39c12;
            border: 1px solid #f39c12;
            padding: 1px 3px;
        }

        @keyframes amber-pulse {
            from { box-shadow: 0 0 5px rgba(243, 156, 18, 0.1); border-color: rgba(243, 156, 18, 0.3); }
            to { box-shadow: 0 0 15px rgba(243, 156, 18, 0.3); border-color: rgba(243, 156, 18, 0.8); }
        }

        /* CONTENT CONTAINERS */
        .content-section { max-width: 1000px; margin: -40px auto 60px; padding: 0 20px; position: relative; z-index: 5; }
        .card {
            background: #161b22;
            border-radius: 12px;
            padding: 40px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 40px; }
        .feature-item { background: #0d1117; padding: 25px; border-radius: 10px; border: 1px solid #30363d; }
        .feature-item h3 { color: #4a6a8c; margin-bottom: 10px; }

        .partner-img { width: 100%; height: 100px; object-fit: contain; margin-bottom: 15px; background: #1c2128; border-radius: 8px; padding: 10px; }

        .login-box {
            background: #161b22;
            max-width: 400px;
            margin: 40px auto;
            padding: 40px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 0.8rem; color: #8b9eb3; }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            background: #0d1117;
            border: 1px solid #30363d;
            color: white;
            font-family: inherit;
        }

        /* DASHBOARD ELEMENTS */
        .dashboard-layout { display: flex; min-height: calc(100vh - 70px); }
        .sidebar { width: 240px; background: #0d1117; border-right: 1px solid #30363d; padding: 20px; }
        .sidebar-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 12px 15px;
            text-align: left;
            background: none;
            border: none;
            color: #8b9eb3;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .sidebar-btn.active { background: #4a6a8c; color: white; }
        .sidebar-btn:hover:not(.active) { background: rgba(255, 255, 255, 0.05); }

        .sidebar-badge {
            background: #e74c3c;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        .main-dash { flex: 1; padding: 40px; background: #0d1117; overflow-y: auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .data-table { width: 100%; border-collapse: collapse; margin-top: 0; font-size: 0.9rem; min-width: 600px; }
        .data-table th { text-align: left; padding: 12px; border-bottom: 2px solid #30363d; color: #4a6a8c; }
        .data-table td { padding: 12px; border-bottom: 1px solid #30363d; }

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-pending { background: #f39c12; color: white; }
        .badge-approved { background: #27ae60; color: white; }
        .badge-denied { background: #c0392b; color: white; }

        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: #4a6a8c; color: white; }
        .btn-danger { background: #c0392b; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }

        .tips-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .tip-box { background: #1c2128; border: 1px solid #30363d; padding: 15px; border-radius: 8px; text-align: center; transition: 0.3s; }

        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-body { background: #161b22; padding: 30px; border-radius: 12px; width: 440px; text-align: center; border: 1px solid rgba(255,255,255,0.1); max-width: 90%; }
        .action-modal { background: #161b22; padding: 30px; border-radius: 12px; width: 440px; text-align: left; }

        footer { padding: 40px; text-align: center; color: #484f58; font-size: 0.8rem; border-top: 1px solid #30363d; }

        .welcome-banner { background: #1c2128; padding: 20px; border-radius: 8px; border-left: 4px solid #4a6a8c; margin-bottom: 20px; }
        
        .forgot-link { display: block; margin-top: 15px; text-align: center; font-size: 0.85rem; color: #8b9eb3; text-decoration: none; cursor: pointer; }

        .insight-card { border-left: 3px solid #4a6a8c; background: #0d1117; padding: 20px; border-radius: 0 8px 8px 0; margin-bottom: 20px; }
        .insight-card ul { list-style: none; padding-left: 5px; }
        .insight-card li { margin-bottom: 8px; color: #cfd8e3; font-size: 0.9rem; display: flex; align-items: flex-start; gap: 10px; }
        .insight-card li::before { content: "•"; color: #4a6a8c; font-weight: bold; }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }

            .logo-area {
                width: 100%;
                justify-content: center;
            }

            nav {
                width: 100%;
                overflow-x: auto;
                white-space: nowrap;
                justify-content: flex-start;
                padding-bottom: 5px; /* Scrollbar space */
            }

            nav a {
                margin-left: 0;
                margin-right: 20px;
                font-size: 0.9rem;
                padding: 5px 0;
            }

            .hero { height: 50vh; }
            .hero-title { font-size: 2rem; }
            
            .content-section { margin-top: -20px; }
            .card { padding: 20px; }

            /* Collapse Grids */
            .responsive-grid,
            .join-btn-container,
            .tips-grid {
                grid-template-columns: 1fr !important;
            }

            /* Dashboard Layout */
            .dashboard-layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #30363d;
                padding: 10px;
                display: flex;
                overflow-x: auto;
                white-space: nowrap;
                gap: 10px;
            }

            .sidebar h2, .sidebar hr { display: none; }
            
            .sidebar-btn {
                width: auto;
                margin-bottom: 0;
                background: rgba(255,255,255,0.05);
                border-radius: 20px;
                justify-content: center;
                white-space: nowrap;
                flex-shrink: 0;
            }
            .sidebar-btn.active { background: #4a6a8c; }

            .main-dash { padding: 20px; }

            /* Fix recruit modal on mobile */
            .recruit-content {
                clip-path: none; 
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>

<!-- MODALS -->
<div id="generalModal" class="modal">
    <div class="modal-body">
        <h3 id="modalTitle">Notice</h3>
        <div id="modalContentArea" style="margin: 20px 0; text-align: left;">
            <p id="modalText" style="color: #cfd8e3; white-space: pre-line; line-height: 1.8;"></p>
        </div>
        <button onclick="closeModal()" class="btn btn-primary" style="width: 100%;">Close</button>
    </div>
</div>

<!-- ACTION MODAL FOR LOA/REPORTS -->
<div id="actionModal" class="modal">
    <div class="modal-body action-modal">
        <h3 id="actionModalTitle">Process Request</h3>
        <p id="actionModalText" style="margin: 10px 0; font-size: 0.9rem; color: #8b9eb3;"></p>
        <div class="input-group">
            <label>Staff Comment / Reason</label>
            <textarea id="actionReasonInput" rows="3" placeholder="Enter reason for this decision..."></textarea>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button id="actionConfirmBtn" class="btn btn-success" style="flex:1;">Confirm</button>
            <button onclick="closeActionModal()" class="btn" style="flex:1; background:#444; color:white;">Cancel</button>
        </div>
    </div>
</div>

<!-- FORGOT PASSWORD MODAL -->
<div id="forgotPasswordModal" class="modal">
    <div class="modal-body action-modal">
        <h3>Account Access Request</h3>
        <p style="margin: 10px 0; font-size: 0.85rem; color: #8b9eb3;">Having trouble signing in? Submit your details and our management team will assist you.</p>
        
        <div class="input-group">
            <label>The Drivername (ID)</label>
            <input type="text" id="forgotDriverId" placeholder="e.g. Driver_123">
        </div>
        <div class="input-group">
            <label>Your Discord User</label>
            <input type="text" id="forgotDiscord" placeholder="e.g. user#1234">
        </div>
        <div class="input-group">
            <label>What do you want to change it to?</label>
            <input type="password" id="forgotNewPass" placeholder="Enter requested access key">
        </div>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="submitForgotPassword()" class="btn btn-primary" style="flex:1;">Send Request</button>
            <button onclick="closeForgotModal()" class="btn" style="flex:1; background:#444; color:white;">Cancel</button>
        </div>
    </div>
</div>

<!-- HEADER -->
<header id="mainHeader">
    <div class="logo-area" onclick="showView('home')">
        <img src="NSL_CLEAR_NO_TEXT.jpg" alt="NSL" onerror="this.style.display='none'">
        <h1>NorthStar</h1>
    </div>
    <nav>
        <a onclick="showView('home')">Home</a>
        <a onclick="showView('company')">Company Info</a>
        <a onclick="showView('partnership')">Partnerships</a>
        <a onclick="showView('report')">Report a Driver</a>
        <a onclick="showView('login')" class="portal-btn">Driver Portal</a>
    </nav>
</header>

<!-- HOME VIEW -->
<div id="homeView" class="page-view active">
    <section class="hero" id="homeHero">
        <h1 class="hero-title">NorthStar Logistics</h1>
        <p class="hero-sub">Leading the way in virtual simulation transport. We provide a professional, friendly, and realistic driving environment for enthusiasts worldwide.</p>
        <div style="margin-top: 25px;">
            <button class="btn btn-primary" onclick="showJoinInstructions()">Join Our Fleet</button>
        </div>
    </section>
    <div class="content-section">
        <div class="card">
            <h2 style="text-align: center; margin-bottom: 20px;">Why Drive With Us?</h2>
            <div class="feature-grid">
                <div class="feature-item">
                    <h3>Professionalism</h3>
                    <p>We take our operations seriously while maintaining a fun atmosphere for all drivers.</p>
                </div>
                <div class="feature-item">
                    <h3>Community</h3>
                    <p>Join a group of like-minded individuals who share a passion for the open road.</p>
                </div>
                <div class="feature-item">
                    <h3>Growth</h3>
                    <p>Rank up through our driver levels and take on more challenging specialized hauls.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- COMPANY INFO VIEW -->
<div id="companyView" class="page-view">
    <section class="hero" id="companyHero">
        <h1 class="hero-title">Our Organization</h1>
        <p class="hero-sub">Founded on the principles of integrity and safety.</p>
    </section>
    <div class="content-section">
        <div class="card">
            <h2>About NorthStar</h2>
            <p style="margin-top: 15px; color: #8b9eb3;">NorthStar Logistics started as a small group of friends and has grown into a respected Virtual Trucking Company. Our mission is to provide the most realistic logistics experience in the simulation world.</p>
            
            <div class="responsive-grid" style="margin-top: 30px;">
                <div class="feature-item">
                    <h4 style="color:#4a6a8c">Company Drivers</h4>
                    <h2 id="dispDrivers">0</h2>
                </div>
                <div class="feature-item">
                    <h4 style="color:#4a6a8c">Jobs Completed</h4>
                    <h2 id="dispJobs">0</h2>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PARTNERSHIP VIEW -->
<div id="partnershipView" class="page-view">
    <section class="hero" id="partnerHero">
        <h1 class="hero-title">Our Partners</h1>
        <p class="hero-sub">Collaborating with the best in the industry to enhance our services.</p>
    </section>
    <div class="content-section">
        <div class="card">
            <h2 style="margin-bottom: 20px;">Affiliated Companies</h2>
            <div id="publicPartnerGrid" class="feature-grid">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>
</div>

<!-- REPORT A DRIVER VIEW -->
<div id="reportView" class="page-view">
    <section class="hero" id="reportHero">
        <h1 class="hero-title">Public Reporting</h1>
        <p class="hero-sub">Help us maintain our professional standards. Submit reports for reckless driving or misconduct.</p>
    </section>
    <div class="content-section">
        <div class="card">
            <h2>Driver Conduct Report</h2>
            <p style="margin: 10px 0 25px; color: #8b9eb3; font-size: 0.9rem;">Please provide as much detail as possible. False reports may lead to a permanent ban from our community servers.</p>
            
            <div class="responsive-grid">
                <div class="input-group">
                    <label>Driver ID / Name</label>
                    <input type="text" id="repDriverId" placeholder="Who are you reporting?">
                </div>
                <div class="input-group">
                    <label>Date & Time of Incident</label>
                    <input type="datetime-local" id="repDateTime">
                </div>
            </div>
            <div class="input-group">
                <label>Evidence Link (Video/Screenshot)</label>
                <input type="text" id="repEvidence" placeholder="https://youtube.com/... or Imgur link">
            </div>
            <div class="input-group">
                <label>Description of Incident</label>
                <textarea id="repDesc" rows="4" placeholder="Explain what happened..."></textarea>
            </div>
            <div class="input-group">
                <label>Your Contact Info (Optional)</label>
                <input type="text" id="repContact" placeholder="Your Discord or Email">
            </div>
            <button class="btn btn-danger" style="width:100%; padding: 15px;" onclick="submitPublicReport()">Submit Official Report</button>
        </div>
    </div>
</div>

<!-- LOGIN VIEW -->
<div id="loginView" class="page-view">
    <div class="login-box">
        <div style="display:flex; gap:10px; margin-bottom:30px; border-bottom: 1px solid #30363d;">
            <button id="modeDriver" onclick="setAuthMode('driver')" style="flex:1; padding:10px; background:none; border:none; color:#4a6a8c; border-bottom:2px solid #4a6a8c; font-weight:bold; cursor:pointer;">Driver</button>
            <button id="modeAdmin" onclick="setAuthMode('admin')" style="flex:1; padding:10px; background:none; border:none; color:#8b9eb3; font-weight:bold; cursor:pointer;">Staff</button>
        </div>
        <form id="authForm" onsubmit="handleLogin(event)">
            <div class="input-group">
                <label id="userLabel">Driver ID</label>
                <input type="text" id="userInput" placeholder="Enter ID" required>
            </div>
            <div class="input-group">
                <label>Access Key</label>
                <input type="password" id="passInput" placeholder="••••••••" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Sign In</button>
            <a class="forgot-link" onclick="openForgotModal()">Forgot password?</a>
        </form>
    </div>
</div>

<!-- DRIVER DASHBOARD -->
<div id="driverPanelView" class="page-view" style="padding-top:0;">
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div style="margin-bottom: 20px;">
                <h2 style="font-size: 1rem; color: #4a6a8c; margin-bottom: 5px;">DRIVER HUB</h2>
                <div id="sidebarDriverRank" style="font-size: 0.7rem; color: #8b9eb3; text-transform: uppercase; letter-spacing: 1px;">Rank: Trainee</div>
            </div>
            <button class="sidebar-btn active" id="btnDDash" onclick="switchTab('driver', 'dash')">Dashboard</button>
            <button class="sidebar-btn" id="btnDLog" onclick="switchTab('driver', 'log')">Submit Log</button>
            <button class="sidebar-btn" id="btnDInsights" onclick="switchTab('driver', 'insights')">Insights</button>
            <button class="sidebar-btn" id="btnDLoa" onclick="switchTab('driver', 'loa')">Request LOA</button>
            <button class="sidebar-btn" id="btnDHistory" onclick="switchTab('driver', 'history')">History</button>
            <hr style="border:0; border-top:1px solid #30363d; margin: 20px 0;">
            <button class="sidebar-btn" style="color:#e74c3c" onclick="logout()">Logout</button>
        </aside>
        <main class="main-dash">
            <div class="welcome-banner">
                <h2 id="driverWelcomeMsg">Welcome, Driver</h2>
                <p style="color: #8b9eb3; font-size: 0.9rem;">Personnel Portal | NorthStar Fleet Systems</p>
            </div>

            <!-- DASHBOARD TAB (HOME) -->
            <div id="tabDDash" class="tab-content active">
                <div class="tips-grid">
                    <div class="tip-box">
                        <h5>Pro Tip #1</h5>
                        <p>Don't drive 100 on a bend. Physics always wins.</p>
                    </div>
                    <div class="tip-box">
                        <h5>Pro Tip #2</h5>
                        <p>Keep an eye out for lights. Red means stop, not floor it.</p>
                    </div>
                    <div class="tip-box">
                        <h5>Pro Tip #3</h5>
                        <p>Watch out for that tree. It's harder than your bumper.</p>
                    </div>
                </div>

                <div style="margin-top:30px;">
                    <div class="card">
                        <h3 style="margin-bottom:15px; color:#4a6a8c">Live Fleet Bulletin</h3>
                        <div id="driverBulletinBoard"></div>
                    </div>
                </div>
            </div>

            <!-- SUBMIT LOG TAB -->
            <div id="tabDLog" class="tab-content">
                <h2>New Delivery Job</h2>
                <div class="card" style="margin-top: 20px;">
                    <div class="responsive-grid">
                        <div class="input-group"><label>Source City</label><input type="text" id="jobStart" placeholder="City, Country"></div>
                        <div class="input-group"><label>Destination</label><input type="text" id="jobEnd" placeholder="City, Country"></div>
                        <div class="input-group"><label>Cargo Type</label><input type="text" id="jobCargo" placeholder="e.g. Medical Supplies"></div>
                        <div class="input-group"><label>Job Time (Hrs)</label><input type="number" id="jobTime" step="0.1" placeholder="0.0"></div>
                        <div class="input-group"><label>Income</label><input type="number" id="jobIncome" placeholder="e.g. 15000"></div>
                    </div>
                    <button class="btn btn-success" style="width:100%; margin-top: 10px;" onclick="submitJob()">Log Delivery</button>
                </div>
            </div>

            <!-- SAFETY INSIGHTS TAB -->
            <div id="tabDInsights" class="tab-content">
                <h2>Safety Insights & Driver Handbook</h2>
                <p style="color: #8b9eb3; margin-bottom: 25px;">Essential protocols for NorthStar Logistics personnel.</p>
                
                <div class="insight-card">
                    <h4>Pre-Trip Inspection Checklist</h4>
                    <ul>
                        <li>Verify tire pressure and tread depth on both truck and trailer.</li>
                        <li>Ensure all lights (headlights, signals, brake lights) are operational.</li>
                        <li>Check fluid levels: Oil, Coolant, and Diesel Exhaust Fluid (DEF).</li>
                        <li>Secure all cargo latches and verify weight distribution.</li>
                    </ul>
                </div>

                <div class="insight-card">
                    <h4>Safe Driving Protocols</h4>
                    <ul>
                        <li>Maintain a 4-second following distance in clear conditions.</li>
                        <li>Observe all regional speed limits; company maximum is 90km/h (56mph).</li>
                        <li>Use indicators at least 3 seconds before initiating any lane change.</li>
                        <li>Dim high beams when within 500ft of oncoming traffic.</li>
                    </ul>
                </div>

                <div class="insight-card">
                    <h4>Adverse Weather Procedures</h4>
                    <ul>
                        <li><strong>Heavy Rain/Fog:</strong> Reduce speed by 20% and increase following distance to 8 seconds.</li>
                        <li><strong>Snow/Ice:</strong> Avoid sudden braking; use engine braking (Jake brakes) cautiously to prevent jackknifing.</li>
                        <li>If visibility drops below 35 meters, pull over to a safe rest area until conditions improve.</li>
                    </ul>
                </div>

                <div class="insight-card">
                    <h4>Incident Management</h4>
                    <ul>
                        <li>In the event of a collision, immediately engage hazard lights.</li>
                        <li>Capture screenshots or video evidence of the scene and participants.</li>
                        <li>Do not engage in verbal altercations; record IDs and report via the Portal.</li>
                        <li>Contact Staff via Discord if emergency assistance is required.</li>
                    </ul>
                </div>
            </div>

            <!-- LOA TAB -->
            <div id="tabDLoa" class="tab-content">
                <h2>Request Leave of Absence (LOA)</h2>
                <div class="card" style="margin-top: 20px;">
                    <p style="color: #8b9eb3; margin-bottom: 20px; font-size: 0.9rem;">Absences longer than 7 days require management approval.</p>
                    <div class="responsive-grid">
                        <div class="input-group"><label>Start Date</label><input type="date" id="loaStart"></div>
                        <div class="input-group"><label>End Date</label><input type="date" id="loaEnd"></div>
                    </div>
                    <div class="input-group">
                        <label>Reason for Leave</label>
                        <textarea id="loaReason" rows="3" placeholder="Brief explanation..."></textarea>
                    </div>
                    <button class="btn btn-primary" style="width:100%" onclick="submitLoa()">Submit Time-Off Request</button>
                </div>
                <h3 style="margin-top: 30px;">Your LOA History</h3>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead><tr><th>Dates</th><th>Reason</th><th>Status</th><th>Staff Comment</th></tr></thead>
                        <tbody id="driverLoaList"></tbody>
                    </table>
                </div>
            </div>

            <!-- HISTORY TAB -->
            <div id="tabDHistory" class="tab-content">
                <h2>Your Logged Deliveries</h2>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead><tr><th>Route</th><th>Cargo</th><th>Time</th><th>Income</th></tr></thead>
                        <tbody id="driverHistoryList"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- ADMIN DASHBOARD -->
<div id="adminPanelView" class="page-view" style="padding-top:0;">
    <div class="dashboard-layout">
        <aside class="sidebar">
            <h2 style="font-size: 1rem; color: #e74c3c; margin-bottom: 20px;">MANAGEMENT</h2>
            <button class="sidebar-btn active" id="btnADrivers" onclick="switchTab('admin', 'drivers')">Drivers</button>
            <button class="sidebar-btn" id="btnABulletins" onclick="switchTab('admin', 'bulletins')">Bulletins</button>
            <button class="sidebar-btn" id="btnAReports" onclick="switchTab('admin', 'reports')">
                Reports <span class="sidebar-badge" id="reportBadge" style="display:none">0</span>
            </button>
            <button class="sidebar-btn" id="btnAAccount" onclick="switchTab('admin', 'account')">
                Account <span class="sidebar-badge" id="forgotBadge" style="display:none">0</span>
            </button>
            <button class="sidebar-btn" id="btnALogs" onclick="switchTab('admin', 'logs')">Company Logs</button>
            <button class="sidebar-btn" id="btnALoa" onclick="switchTab('admin', 'loa')">LOA Requests</button>
            <button class="sidebar-btn" id="btnAPartners" onclick="switchTab('admin', 'partners')">Partners</button>
            <button class="sidebar-btn" id="btnABranding" onclick="switchTab('admin', 'branding')">Assets</button>
            <hr style="border:0; border-top:1px solid #30363d; margin: 20px 0;">
            <button class="sidebar-btn" style="color:#e74c3c" onclick="logout()">Logout</button>
        </aside>
        <main class="main-dash">
            <div class="welcome-banner" style="border-left-color: #e74c3c;">
                <h2 id="adminWelcomeMsg">Welcome, Staff</h2>
                <p style="color: #8b9eb3; font-size: 0.9rem;">Fleet Management & Logistics Control Panel</p>
            </div>

            <div id="tabADrivers" class="tab-content active">
                <h2>Personnel & Stats Management</h2>
                <div class="responsive-grid">
                    <div class="card" style="border: 1px solid #4a6a8c;">
                        <h4 style="color:#4a6a8c; margin-bottom:10px;">Company Overview Stats</h4>
                        <div class="input-group">
                            <label>Active Drivers Count</label>
                            <input type="number" id="editActiveDrivers" value="0">
                        </div>
                        <div class="input-group">
                            <label>Jobs Completed Count</label>
                            <input type="number" id="editJobsCompleted" value="0">
                        </div>
                        <button class="btn btn-primary" onclick="updateManualStats()" style="width:100%">Save Public Stats</button>
                    </div>
                    <div class="card">
                        <h4>Create New Driver Account</h4>
                        <div class="input-group">
                            <label>New Driver ID</label>
                            <input type="text" id="addDId" placeholder="New Driver ID">
                        </div>
                        <div class="input-group">
                            <label>Set Access Key</label>
                            <input type="text" id="addDPass" placeholder="Set Access Key">
                        </div>
                        <button class="btn btn-primary" onclick="adminAddDriver()" style="width:100%">Register Account</button>
                    </div>
                </div>
                <div style="margin-top: 30px;">
                    <h3>Active Personnel Management</h3>
                    <div id="adminDriverCards" style="margin-top: 15px;"></div>
                </div>
            </div>

            <!-- BULLETIN MANAGEMENT TAB -->
            <div id="tabABulletins" class="tab-content">
                <h2>Bulletin Board Management</h2>
                <p style="color:#8b9eb3; margin-bottom:20px;">Announcements posted here will appear instantly on all driver dashboards.</p>
                
                <div class="card">
                    <h4>Post New Bulletin</h4>
                    <div class="input-group">
                        <label>Title</label>
                        <input type="text" id="bulTitle" placeholder="e.g. Weekly Convoy">
                    </div>
                    <div class="input-group">
                        <label>Message Content</label>
                        <textarea id="bulBody" rows="3" placeholder="Enter details..."></textarea>
                    </div>
                    <button id="btnPostBulletin" class="btn btn-primary" onclick="addBulletin()">Publish to Fleet</button>
                </div>

                <h3 style="margin-top:30px;">Active Bulletins</h3>
                <div id="adminBulletinList" style="margin-top:15px; display:grid; gap:15px;"></div>
            </div>

            <div id="tabAReports" class="tab-content">
                <h2>Public Incident Reports</h2>
                <div id="adminReportList" style="display:grid; gap:15px;"></div>
            </div>

            <div id="tabAAccount" class="tab-content">
                <h2>Account Access Requests</h2>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead><tr><th>Driver ID</th><th>Discord User</th><th>Requested Pass</th><th>Action</th></tr></thead>
                        <tbody id="adminForgotList"></tbody>
                    </table>
                </div>
            </div>

            <div id="tabALogs" class="tab-content">
                <h2>All Company Logs</h2>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead><tr><th>Driver</th><th>Route</th><th>Cargo</th><th>Action</th></tr></thead>
                        <tbody id="adminGlobalList"></tbody>
                    </table>
                </div>
            </div>

            <div id="tabALoa" class="tab-content">
                <h2>LOA Queue</h2>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead><tr><th>Driver</th><th>Duration</th><th>Reason</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="adminLoaList"></tbody>
                    </table>
                </div>
            </div>

            <div id="tabAPartners" class="tab-content">
                <h2>Manage Affiliated Companies</h2>
                <div class="card" style="margin: 20px 0;">
                    <h4>Add New Partner</h4>
                    <div class="responsive-grid" style="margin-top:15px;">
                        <div class="input-group"><label>Partner Name</label><input type="text" id="partnerNameInput"></div>
                        <div class="input-group"><label>Role / Description</label><input type="text" id="partnerRoleInput"></div>
                    </div>
                    <div class="input-group"><label>Image URL (Logo)</label><input type="text" id="partnerImgInput"></div>
                    <button class="btn btn-success" onclick="adminAddPartner()" style="width:100%">Add to Affiliates</button>
                </div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead><tr><th>Logo</th><th>Name</th><th>Role</th><th>Actions</th></tr></thead>
                        <tbody id="adminPartnerList"></tbody>
                    </table>
                </div>
            </div>

            <div id="tabABranding" class="tab-content">
                <h2>Update Page Assets</h2>
                <div class="card">
                    <div class="input-group"><label>Home Hero (URL)</label><input type="text" id="heroHomeUrl"></div>
                    <div class="input-group"><label>Company Hero (URL)</label><input type="text" id="heroCompanyUrl"></div>
                    <div class="input-group"><label>Partner Hero (URL)</label><input type="text" id="heroPartnerUrl"></div>
                    <div class="input-group"><label>Report Hero (URL)</label><input type="text" id="heroReportUrl"></div>
                    <button class="btn btn-primary" onclick="updateHeroAssets()" style="width:100%; margin-top: 10px;">Update Backgrounds</button>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- JOIN OUR FLEET MODAL (FUTURISTIC) -->
<div id="recruitModal" class="recruit-modal">
    <div class="recruit-content">
        <h3 style="margin-bottom: 15px;">Join Our Fleet</h3>
        <img src="image_c14365.png" alt="NorthStar Logistics Recruitment" class="recruit-image">
        <div class="join-btn-container">
            <a href="https://hub.truckyapp.com/vtc/northstar-logistics" target="_blank" class="join-option">
                <strong>Trucky Hub</strong>
                <span>Apply Now</span>
            </a>
            <div class="join-option disabled">
                <strong>TruckersMP</strong>
                <span>Coming Soon</span>
            </div>
        </div>
        <a href="https://discord.gg/2GNHKbJeDM" target="_blank" class="join-option" style="margin-top: 15px; flex-direction: row; justify-content: center; gap: 10px;">
            <span style="background:#5865f2; padding: 2px 8px; border-radius: 4px;">Discord</span>
            <strong>Join our Community</strong>
        </a>
        <button onclick="closeRecruitModal()" class="btn btn-primary" style="width: 100%; margin-top: 20px; background: #333; border: 1px solid #555;">Close Terminal</button>
    </div>
</div>

<footer>&copy; 2025 NorthStar Logistics | Professional Trucking Simulations</footer>

<script>
    let editingBulletinId = null;

    const state = {
        drivers: [], 
        logs: [],
        loas: [], 
        forgotRequests: [],
        reports: [],
        bulletins: [
            { id: 1, title: "Company Convoy: Weekend Run", body: "Meeting at Berlin Garage this Saturday. Be there with a clean rig!" },
            { id: 2, title: "Economy Update", body: "Cargo rates for heavy machinery have increased by 5% this week." }
        ],
        admins: [{ id: "sprogg28", pass: "Fast&Truck4", rank: "Owner" }],
        ranks: ["Trainee", "Junior Driver", "Driver", "Staff", "Convoy Team", "Management"],
        manualStats: { drivers: 0, jobs: 0 },
        assets: {
            homeHero: 'https://images.unsplash.com/photo-1519003722824-194d4455a60c?auto=format&fit=crop&q=80&w=2000',
            companyHero: 'https://images.unsplash.com/photo-1586528116311-ad8dd3c8310d?auto=format&fit=crop&q=80&w=2000',
            partnerHero: 'https://images.unsplash.com/photo-1521737711867-e3b97375f902?auto=format&fit=crop&q=80&w=2000',
            reportHero: 'https://images.unsplash.com/photo-1454165833767-027ffea9e778?auto=format&fit=crop&q=80&w=2000'
        },
        partners: [] 
    };

    let currentUser = null;
    let authMode = 'driver';

    function showView(viewId) {
        document.querySelectorAll('.page-view').forEach(v => v.classList.remove('active'));
        const target = document.getElementById(viewId + 'View');
        if (target) target.classList.add('active');

        document.getElementById('mainHeader').style.display = viewId.includes('Panel') ? 'none' : 'flex';
        
        if (viewId === 'partnership') renderPublicPartners();
        if (viewId === 'company') updatePublicCounters();
        if (viewId === 'adminPanel') {
            document.getElementById('adminWelcomeMsg').innerText = `Welcome, ${currentUser.id}`;
            renderAdminDrivers();
            renderAdminForgot();
            renderAdminReports();
            renderAdminBulletins();
            document.getElementById('editActiveDrivers').value = state.manualStats.drivers;
            document.getElementById('editJobsCompleted').value = state.manualStats.jobs;
            document.getElementById('heroHomeUrl').value = state.assets.homeHero;
            document.getElementById('heroCompanyUrl').value = state.assets.companyHero;
            document.getElementById('heroPartnerUrl').value = state.assets.partnerHero;
            document.getElementById('heroReportUrl').value = state.assets.reportHero;
        }
        
        if (viewId === 'driverPanel') {
            checkLNotifications();
            document.getElementById('driverWelcomeMsg').innerText = `Welcome, ${currentUser.id}`;
            document.getElementById('sidebarDriverRank').innerText = `Rank: ${currentUser.rank || 'Trainee'}`;
            renderDriverBulletins();
            switchTab('driver', 'dash');
        }
        
        window.scrollTo(0, 0);
    }

    function switchTab(panel, tab) {
        const prefix = panel === 'driver' ? 'D' : 'A';
        document.querySelectorAll(`.sidebar-btn`).forEach(b => b.classList.remove('active'));
        document.querySelectorAll(`.tab-content`).forEach(t => t.classList.remove('active'));
        
        const btnId = `btn${prefix}${tab.charAt(0).toUpperCase() + tab.slice(1)}`;
        const btnElem = document.getElementById(btnId);
        if(btnElem) btnElem.classList.add('active');

        const tabId = `tab${prefix}${tab.charAt(0).toUpperCase() + tab.slice(1)}`;
        const tabElem = document.getElementById(tabId);
        if(tabElem) tabElem.classList.add('active');
        
        if (tab === 'history') renderDriverHistory();
        if (tab === 'loa' && panel === 'driver') renderDriverLoa();
        if (tab === 'loa' && panel === 'admin') renderAdminLoa();
        if (tab === 'logs') renderAdminLogs();
        if (tab === 'drivers') renderAdminDrivers();
        if (tab === 'account') renderAdminForgot();
        if (tab === 'partners') renderAdminPartners();
        if (tab === 'reports') renderAdminReports();
        if (tab === 'bulletins') renderAdminBulletins();
    }

    function setAuthMode(mode) {
        authMode = mode;
        const isAdm = mode === 'admin';
        document.getElementById('userLabel').innerText = isAdm ? "Staff ID" : "Driver ID";
        document.getElementById('modeAdmin').style.color = isAdm ? "#4a6a8c" : "#8b9eb3";
        document.getElementById('modeAdmin').style.borderBottom = isAdm ? "2px solid #4a6a8c" : "none";
        document.getElementById('modeDriver').style.color = isAdm ? "#8b9eb3" : "#4a6a8c";
        document.getElementById('modeDriver').style.borderBottom = isAdm ? "none" : "2px solid #4a6a8c";
    }

    function handleLogin(event) {
        event.preventDefault();
        const u = document.getElementById('userInput').value.trim();
        const p = document.getElementById('passInput').value.trim();
        if (authMode === 'admin') {
            const found = state.admins.find(a => a.id === u && a.pass === p);
            if (found) { currentUser = found; showView('adminPanel'); }
            else { openModal('Staff Access Denied', 'Invalid credentials.'); }
        } else {
            const found = state.drivers.find(d => d.id === u && d.pass === p);
            if (found) { currentUser = found; showView('driverPanel'); }
            else { openModal('Driver Access Denied', 'Invalid ID or Key.'); }
        }
    }

    function logout() { currentUser = null; showView('home'); }

    // --- BULLETIN SYSTEM ---
    function renderDriverBulletins() {
        const board = document.getElementById('driverBulletinBoard');
        board.innerHTML = state.bulletins.map(b => `
            <div style="border-left: 2px solid #30363d; padding-left:15px; margin-bottom:15px;">
                <h4 style="font-size:0.9rem; color:#4a6a8c;">${b.title}</h4>
                <p style="font-size:0.85rem; color:#8b9eb3;">${b.body}</p>
            </div>
        `).join('');
    }

    function renderAdminBulletins() {
        const list = document.getElementById('adminBulletinList');
        list.innerHTML = state.bulletins.map(b => `
            <div class="card" style="padding:15px; display:flex; justify-content:space-between; align-items:center;">
                <div style="flex:1;">
                    <strong>${b.title}</strong>
                    <p style="font-size:0.8rem; color:#8b9eb3;">${b.body}</p>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary btn-sm" onclick="editBulletin(${b.id})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteBulletin(${b.id})">Delete</button>
                </div>
            </div>
        `).join('');
    }

    function addBulletin() {
        const t = document.getElementById('bulTitle').value;
        const b = document.getElementById('bulBody').value;
        const btn = document.getElementById('btnPostBulletin');

        if (!t || !b) return openModal("Error", "Please fill in title and body.");

        if (editingBulletinId) {
            const index = state.bulletins.findIndex(x => x.id === editingBulletinId);
            if (index !== -1) {
                state.bulletins[index].title = t;
                state.bulletins[index].body = b;
                openModal("Success", "Bulletin updated.");
            }
            editingBulletinId = null;
            btn.innerText = "Publish to Fleet";
            btn.className = "btn btn-primary";
        } else {
            state.bulletins.push({ id: Date.now(), title: t, body: b });
            openModal("Success", "Bulletin posted.");
        }

        document.getElementById('bulTitle').value = "";
        document.getElementById('bulBody').value = "";
        renderAdminBulletins();
    }

    function editBulletin(id) {
        const bul = state.bulletins.find(b => b.id === id);
        if (!bul) return;

        document.getElementById('bulTitle').value = bul.title;
        document.getElementById('bulBody').value = bul.body;
        editingBulletinId = id;

        const btn = document.getElementById('btnPostBulletin');
        btn.innerText = "Update Bulletin";
        btn.className = "btn btn-success";
    }

    function deleteBulletin(id) {
        state.bulletins = state.bulletins.filter(b => b.id !== id);
        renderAdminBulletins();
    }

    // --- EXISTING FUNCTIONS ---
    function submitPublicReport() {
        const dId = document.getElementById('repDriverId').value.trim();
        const dTime = document.getElementById('repDateTime').value;
        const ev = document.getElementById('repEvidence').value.trim();
        const desc = document.getElementById('repDesc').value.trim();
        const contact = document.getElementById('repContact').value.trim();

        if (!dId || !dTime || !desc) return openModal('Incomplete', 'Driver ID, Date, and Description are required.');

        state.reports.unshift({
            id: Date.now(),
            target: dId,
            time: dTime,
            evidence: ev,
            description: desc,
            contact: contact,
            status: 'Pending'
        });

        document.getElementById('repDriverId').value = "";
        document.getElementById('repDateTime').value = "";
        document.getElementById('repEvidence').value = "";
        document.getElementById('repDesc').value = "";
        document.getElementById('repContact').value = "";

        openModal('Report Filed', 'Thank you. Our management team will investigate this incident.');
        updateAdminBadges();
    }

    function renderAdminReports() {
        const container = document.getElementById('adminReportList');
        container.innerHTML = state.reports.length ? "" : "<p style='color:#8b9eb3;'>No active reports to review.</p>";
        
        state.reports.forEach(r => {
            const card = document.createElement('div');
            card.className = "card";
            card.style.borderLeft = `4px solid ${r.status === 'Resolved' ? '#27ae60' : '#e74c3c'}`;
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <div>
                        <h4 style="color:#e74c3c">Report against: ${r.target}</h4>
                        <p style="font-size:0.8rem; color:#8b9eb3;">Occurred: ${r.time.replace('T', ' ')}</p>
                    </div>
                    <span class="badge ${r.status === 'Resolved' ? 'badge-approved' : 'badge-pending'}">${r.status}</span>
                </div>
                <div style="margin:15px 0; background:#0d1117; padding:10px; border-radius:6px; font-size:0.9rem;">
                    <p>${r.description}</p>
                    ${r.evidence ? `<p style="margin-top:10px;"><a href="${r.evidence}" target="_blank" style="color:#4a6a8c">View Evidence Link</a></p>` : ''}
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <small style="color:#4a6a8c">Contact: ${r.contact || 'Anonymous'}</small>
                    <div>
                        <button onclick="resolveReport(${r.id})" class="btn btn-success btn-sm">Mark Resolved</button>
                        <button onclick="deleteReport(${r.id})" class="btn btn-danger btn-sm">Delete</button>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
        updateAdminBadges();
    }

    function deleteReport(id) {
        state.reports = state.reports.filter(x => x.id !== id);
        renderAdminReports();
    }

    function resolveReport(id) {
        const r = state.reports.find(x => x.id === id);
        if (r) r.status = 'Resolved';
        renderAdminReports();
    }

    function submitJob() {
        const s = document.getElementById('jobStart').value;
        const e = document.getElementById('jobEnd').value;
        const c = document.getElementById('jobCargo').value;
        const t = document.getElementById('jobTime').value;
        const inc = document.getElementById('jobIncome').value;

        if (!s || !e || !c || !inc) return openModal('Error', 'Please fill in all city, cargo, and income details.');
        
        const newJob = { 
            id: Date.now(), 
            driver: currentUser.id, 
            start: s, 
            end: e, 
            cargo: c, 
            time: t || 0,
            income: inc
        };

        state.logs.unshift(newJob);
        
        document.getElementById('jobStart').value = "";
        document.getElementById('jobEnd').value = "";
        document.getElementById('jobCargo').value = "";
        document.getElementById('jobTime').value = "";
        document.getElementById('jobIncome').value = "";

        openModal('Logged', 'Delivery recorded and sent to dispatch.');
        switchTab('driver', 'history');
    }

    function renderDriverHistory() {
        const body = document.getElementById('driverHistoryList');
        const myLogs = state.logs.filter(l => l.driver === currentUser.id);
        body.innerHTML = myLogs.length ? "" : "<tr><td colspan='4'>No jobs found.</td></tr>";
        myLogs.forEach(l => { 
            body.innerHTML += `<tr><td>${l.start} ➔ ${l.end}</td><td>${l.cargo}</td><td>${l.time}h</td><td>$${parseFloat(l.income).toLocaleString()}</td></tr>`; 
        });
    }

    function submitLoa() {
        const start = document.getElementById('loaStart'), end = document.getElementById('loaEnd'), res = document.getElementById('loaReason');
        if (!start.value || !end.value || !res.value) return openModal('Error', 'Missing info.');
        state.loas.unshift({ id: Date.now(), driver: currentUser.id, start: start.value, end: end.value, reason: res.value, status: 'Pending', comment: "", seen: false });
        start.value = ""; end.value = ""; res.value = "";
        openModal('Success', 'LOA sent.');
        renderDriverLoa();
    }

    function renderDriverLoa() {
        const body = document.getElementById('driverLoaList');
        const myLoas = state.loas.filter(l => l.driver === currentUser.id);
        body.innerHTML = myLoas.length ? "" : "<tr><td colspan='4'>No history.</td></tr>";
        myLoas.forEach(l => { body.innerHTML += `<tr><td>${l.start}/${l.end}</td><td>${l.reason}</td><td><span class="badge badge-${l.status.toLowerCase()}">${l.status}</span></td><td><small>${l.comment}</small></td></tr>`; });
    }

    function adminAddDriver() {
        const i = document.getElementById('addDId'), p = document.getElementById('addDPass');
        if (!i.value || !p.value) return;
        state.drivers.push({ id: i.value, pass: p.value, rank: "Trainee" });
        i.value = ""; p.value = ""; renderAdminDrivers();
    }

    function renderAdminDrivers() {
        const container = document.getElementById('adminDriverCards');
        container.innerHTML = state.drivers.length ? "" : "<p style='color:#8b9eb3'>No drivers registered.</p>";
        state.drivers.forEach((d, idx) => {
            const card = document.createElement('div');
            card.className = "card";
            card.style.marginBottom = "10px";
            card.innerHTML = `
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:10px; align-items:end;">
                    <div class="input-group" style="margin:0;"><label>ID</label><input type="text" value="${d.id}" onchange="state.drivers[${idx}].id=this.value"></div>
                    <div class="input-group" style="margin:0;"><label>Rank</label><select onchange="state.drivers[${idx}].rank=this.value">${state.ranks.map(r=>`<option ${d.rank===r?'selected':''}>${r}</option>`).join('')}</select></div>
                    <div class="input-group" style="margin:0;"><label>Pass</label><input type="text" value="${d.pass}" onchange="state.drivers[${idx}].pass=this.value"></div>
                    <button class="btn btn-danger" onclick="deleteAdminDriver(${idx})">X</button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function deleteAdminDriver(idx) {
        state.drivers.splice(idx, 1);
        renderAdminDrivers();
    }

    function renderAdminForgot() {
        const body = document.getElementById('adminForgotList');
        body.innerHTML = state.forgotRequests.length ? "" : "<tr><td colspan='4'>No requests.</td></tr>";
        state.forgotRequests.forEach(r => {
            body.innerHTML += `<tr><td>${r.driverId}</td><td>${r.discord}</td><td>${r.requestedPass}</td><td><button onclick="approveForgotPass(${r.id})" class="btn btn-success btn-sm">Ok</button></td></tr>`;
        });
        updateAdminBadges();
    }

    function updateAdminBadges() {
        const fBadge = document.getElementById('forgotBadge');
        fBadge.innerText = state.forgotRequests.length;
        fBadge.style.display = state.forgotRequests.length ? 'inline-block' : 'none';

        const rBadge = document.getElementById('reportBadge');
        const pendingReports = state.reports.filter(r => r.status === 'Pending').length;
        rBadge.innerText = pendingReports;
        rBadge.style.display = pendingReports ? 'inline-block' : 'none';
    }

    function approveForgotPass(id) {
        const req = state.forgotRequests.find(r => r.id === id);
        const drv = state.drivers.find(d => d.id === req.driverId);
        if (drv) drv.pass = req.requestedPass;
        state.forgotRequests = state.forgotRequests.filter(x=>x.id!==id);
        renderAdminForgot();
    }

    function updateManualStats() {
        state.manualStats.drivers = document.getElementById('editActiveDrivers').value;
        state.manualStats.jobs = document.getElementById('editJobsCompleted').value;
        openModal('Success', 'Stats updated.');
    }

    function updateHeroAssets() {
        state.assets.homeHero = document.getElementById('heroHomeUrl').value;
        state.assets.companyHero = document.getElementById('heroCompanyUrl').value;
        state.assets.partnerHero = document.getElementById('heroPartnerUrl').value;
        state.assets.reportHero = document.getElementById('heroReportUrl').value;
        applyHeroBackgrounds();
        openModal('Success', 'Assets updated.');
    }

    function renderAdminLogs() {
        const body = document.getElementById('adminGlobalList');
        body.innerHTML = state.logs.map(l => `<tr><td>${l.driver}</td><td>${l.start} to ${l.end}</td><td>${l.cargo}</td><td><button onclick="deleteAdminLog(${l.id})" class="btn btn-danger btn-sm">X</button></td></tr>`).join('');
    }

    function deleteAdminLog(id) {
        state.logs = state.logs.filter(x => x.id !== id);
        renderAdminLogs();
    }

    function renderAdminLoa() {
        const body = document.getElementById('adminLoaList');
        const pending = state.loas.filter(l => l.status === 'Pending');
        
        if (pending.length === 0) {
            body.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No pending LOAs.</td></tr>";
            return;
        }

        body.innerHTML = pending.map(l => `
            <tr>
                <td>${l.driver}</td>
                <td>${l.start}/${l.end}</td>
                <td>${l.reason}</td>
                <td><span class="badge badge-pending">Pending</span></td>
                <td>
                    <button onclick="openLoaActionModal(${l.id}, 'Approve')" class="btn btn-success btn-sm">✔</button>
                    <button onclick="openLoaActionModal(${l.id}, 'Deny')" class="btn btn-danger btn-sm">✖</button>
                </td>
            </tr>
        `).join('');
    }

    function openLoaActionModal(id, action) {
        const loa = state.loas.find(l => l.id === id);
        const modal = document.getElementById('actionModal');
        const btn = document.getElementById('actionConfirmBtn');
        
        document.getElementById('actionModalTitle').innerText = action === 'Approve' ? 'Approve LOA' : 'Deny LOA';
        btn.className = `btn btn-${action === 'Approve' ? 'success' : 'danger'}`;
        
        btn.onclick = () => {
            const reason = document.getElementById('actionReasonInput').value;
            if (action === 'Deny' && !reason.trim()) {
                alert("Please provide a reason for denial.");
                return;
            }
            loa.status = action === 'Approve' ? 'Approved' : 'Denied';
            loa.comment = reason;
            closeActionModal(); 
            renderAdminLoa();
        };
        modal.style.display = 'flex';
    }

    function closeActionModal() { 
        document.getElementById('actionModal').style.display = 'none'; 
        document.getElementById('actionReasonInput').value = '';
    }

    function openModal(t, x) { 
        document.getElementById('modalTitle').innerText = t; 
        document.getElementById('modalText').innerText = x; 
        document.getElementById('generalModal').style.display = 'flex'; 
    }
    
    function closeModal() { document.getElementById('generalModal').style.display = 'none'; }
    function openForgotModal() { document.getElementById('forgotPasswordModal').style.display = 'flex'; }
    function closeForgotModal() { document.getElementById('forgotPasswordModal').style.display = 'none'; }
    function openRecruitModal() { document.getElementById('recruitModal').style.display = 'flex'; }
    function closeRecruitModal() { document.getElementById('recruitModal').style.display = 'none'; }
    
    function showJoinInstructions() { 
        openRecruitModal();
    }

    function applyHeroBackgrounds() {
        document.getElementById('homeHero').style.backgroundImage = `url('${state.assets.homeHero}')`;
        document.getElementById('companyHero').style.backgroundImage = `url('${state.assets.companyHero}')`;
        document.getElementById('partnerHero').style.backgroundImage = `url('${state.assets.partnerHero}')`;
        document.getElementById('reportHero').style.backgroundImage = `url('${state.assets.reportHero}')`;
    }

    function updatePublicCounters() {
        document.getElementById('dispDrivers').innerText = state.manualStats.drivers;
        document.getElementById('dispJobs').innerText = state.manualStats.jobs;
    }

    function adminAddPartner() {
        const n = document.getElementById('partnerNameInput').value, r = document.getElementById('partnerRoleInput').value, i = document.getElementById('partnerImgInput').value;
        if(n && r) { 
            state.partners.push({id: Date.now(), name: n, role: r, img: i || "https://via.placeholder.com/200"}); 
            renderAdminPartners(); 
        }
    }

    function renderAdminPartners() {
        document.getElementById('adminPartnerList').innerHTML = state.partners.map(p => `<tr><td><img src="${p.img}" style="width:30px"></td><td>${p.name}</td><td>${p.role}</td><td><button onclick="deletePartner(${p.id})" class="btn btn-danger btn-sm">X</button></td></tr>`).join('');
    }

    function deletePartner(id) {
        state.partners = state.partners.filter(x => x.id !== id);
        renderAdminPartners();
    }

    function renderPublicPartners() {
        const grid = document.getElementById('publicPartnerGrid');
        grid.innerHTML = state.partners.length ? state.partners.map(p => `<div class="feature-item" style="text-align:center;"><img src="${p.img}" class="partner-img"><h4>${p.name}</h4><p>${p.role}</p></div>`).join('') : "<p style='color:#8b9eb3; text-align:center; grid-column: 1/-1;'>No affiliated partners at this time.</p>";
    }

    function submitForgotPassword() {
        const dId = document.getElementById('forgotDriverId').value, disc = document.getElementById('forgotDiscord').value, newP = document.getElementById('forgotNewPass').value;
        if (dId && disc && newP) { 
            state.forgotRequests.push({ id: Date.now(), driverId: dId, discord: disc, requestedPass: newP }); 
            closeForgotModal(); 
            updateAdminBadges(); 
            openModal('Sent', 'Staff notified.'); 
        }
    }

    function checkLNotifications() {
        const unseen = state.loas.filter(l => l.driver === currentUser.id && l.status !== 'Pending' && !l.seen);
        if (unseen.length) { 
            unseen.forEach(l => l.seen = true); 
            openModal('Notice', 'LOA status updated.'); 
        }
    }

    window.onload = () => { applyHeroBackgrounds(); updatePublicCounters(); };
</script>
</body>
</html>
